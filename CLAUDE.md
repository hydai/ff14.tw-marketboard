# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

React SPA dashboard for FF14 Taiwan datacenter (陸行鳥) market board data. Deployed on GitHub Pages at `marketboard.ff14.tw`. The backend API is a separate project at `../ff14.tw-marketboard-api/` deployed at `marketboard-api.ff14.tw`.

## Tech Stack

- React 19, TypeScript 5, Vite 6
- TailwindCSS 4 (CSS-first config via `@theme` in `src/app.css`, no `tailwind.config.js`)
- React Router 7, TanStack React Query 5, Recharts 2
- No ESLint or Prettier — TypeScript strict mode is the only static analysis

## Commands

```bash
npm run dev        # Vite dev server on :5173, proxies /api to marketboard-api.ff14.tw
npm run build      # tsc -b && vite build → dist/, copies 404.html for SPA routing
npm run preview    # Preview production build
npm run typecheck  # tsc --noEmit
npm run fetch-items  # Re-fetch item name database (scripts/fetch-items.mjs)
```

No test framework is configured.

## Architecture

### Directory Layout

- `src/types/api.ts` — All API response interfaces (snake_case from D1, camelCase from KV)
- `src/api/client.ts` — Typed `fetchApi<T>()` + per-endpoint wrappers, uses `VITE_API_BASE` env var
- `src/hooks/` — TanStack Query hooks: useItems, usePrices, useAnalytics (2min refresh), useStatus (30s refresh)
- `src/lib/format.ts` — `formatGil`, `formatPercent`, `formatRelativeTime`, `normalizePriceSummary`, `getHistoryTimestamp`
- `src/lib/constants.ts` — 8 worlds, city names zh-TW, period/direction options
- `src/lib/item-names.ts` — Static item name lookup data (generated by `scripts/fetch-items.mjs`)
- `src/components/layout/` — AppLayout (sidebar + outlet), Sidebar (nav links), PageShell (title + document.title)
- `src/components/ui/` — Shared UI primitives (Card, DataTable, GilAmount, PriceChange, ItemLink, Badge, etc.)
- `src/components/overview/` — Overview page section cards (TrendingPreview, DealsPreview, etc.)
- `src/components/charts/` — PriceHistoryChart (Recharts LineChart), SalesChart (Recharts ScatterChart)
- `src/components/item/` — Item detail sub-components (PriceSummaryCards, WorldPriceTable, ListingsTable)
- `src/pages/` — 7 route pages, lazy-loaded via React.lazy() except OverviewPage

### Code Splitting

Non-landing routes use `React.lazy()` in `App.tsx`. Because this project uses named exports (no default exports), lazy imports use the `.then(m => ({ default: m.PageName }))` pattern. Recharts is only bundled in the ItemDetailPage chunk.

## Critical Patterns

### PriceSummary Dual Format

The `getItem` API returns `priceSummary` from either KV cache (camelCase `PriceSummaryKV`) or D1 fallback (snake_case `PriceSummaryD1`). Always use `normalizePriceSummary()` from `src/lib/format.ts` to get a consistent `PriceSummary` type.

### Cheapest World

`PriceSummary.cheapestWorld` is resolved server-side (backend compares NQ and HQ min prices, picks the overall cheapest). The frontend simply displays it via `summary?.cheapestWorld ?? "-"` in `PriceSummaryCards.tsx`. If it shows "-", the issue is in the backend processors, not the frontend.

### HQ Field

D1 returns `hq` as `number` (0 or 1), NOT boolean. Always compare with `=== 1`.

### Price History Time Column

Resolution determines which column holds the timestamp:
- `raw` → `snapshot_time`
- `hourly` → `hour_timestamp`
- `daily` → `day_timestamp`

Use `getHistoryTimestamp(point, resolution)` from `src/lib/format.ts`.

### API Base URL

- Dev: `VITE_API_BASE` is empty, Vite proxy handles `/api/*` → `https://marketboard-api.ff14.tw`
- Production: `VITE_API_BASE=https://marketboard-api.ff14.tw` set in `.env.production` (read by Vite at build time)

## TypeScript Strictness

`tsconfig.json` enables strict mode plus `noUnusedLocals`, `noUnusedParameters`, and `noUncheckedIndexedAccess`. All indexed access returns `T | undefined` — always handle the undefined case.

## Conventions

- All user-facing text is Traditional Chinese (zh-TW)
- Dark theme: zinc-950 background, zinc-900 cards, zinc-800 borders, gold-400/500 accents
- Gold color palette defined in `src/app.css` via `@theme` directive (gold-50 through gold-900)
- Path alias: `@/*` → `./src/*`
- Named exports for all components (no default exports except App)
- API response types in `src/types/api.ts` match snake_case D1 column names

## Deployment

GitHub Pages with GitHub Actions. Workflow at `.github/workflows/deploy.yml` builds and deploys on push to `master`.

- Custom domain: `marketboard.ff14.tw` (configured via `public/CNAME` and GitHub repo settings)
- DNS: CNAME record pointing `marketboard.ff14.tw` → `hydai.github.io`
- SPA routing: `dist/404.html` is a copy of `index.html` so direct URL access works with React Router
- Env vars: `VITE_API_BASE` set in `.env.production` (committed, not secret)
- `public/.nojekyll` skips Jekyll processing to avoid issues with `_`-prefixed asset files

## API Reference

Backend repo: `../ff14.tw-marketboard-api/`

Key reference files:
- `../ff14.tw-marketboard-api/src/utils/types.ts` — Canonical response interfaces
- `../ff14.tw-marketboard-api/src/api/router.ts` — All routes at `/api/v1`
- `../ff14.tw-marketboard-api/src/api/handlers/*.ts` — Response shapes per endpoint
- `../ff14.tw-marketboard-api/src/config/datacenters.ts` — 8 worlds data
- `../ff14.tw-marketboard-api/migrations/0001_initial_schema.sql` — DB schema

## Frontend Aesthetics

Avoid generic "AI slop" aesthetics. Make creative, distinctive frontends that surprise and delight.

- **Typography**: Choose beautiful, unique fonts. Avoid generic families (Inter, Roboto, Arial, system fonts). Pick distinctive choices that elevate the design.
- **Color & Theme**: Commit to a cohesive aesthetic. Use CSS variables for consistency. Dominant colors with sharp accents outperform timid, evenly-distributed palettes. Draw from IDE themes and cultural aesthetics for inspiration.
- **Motion**: Use animations for effects and micro-interactions. Prioritize CSS-only solutions for HTML. Use Motion library for React when available. Focus on high-impact moments: one well-orchestrated page load with staggered reveals (`animation-delay`) creates more delight than scattered micro-interactions.
- **Backgrounds**: Create atmosphere and depth rather than defaulting to solid colors. Layer CSS gradients, use geometric patterns, or add contextual effects that match the overall aesthetic.

Avoid these cliches:
- Overused font families (Inter, Roboto, Arial, Space Grotesk, system fonts)
- Purple gradients on white backgrounds
- Predictable layouts and cookie-cutter component patterns
- Designs that lack context-specific character

Interpret creatively and make unexpected choices that feel genuinely designed for the context. Vary between light and dark themes, different fonts, different aesthetics. Think outside the box — do not converge on common choices across generations.
